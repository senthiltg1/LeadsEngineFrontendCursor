<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - User Management - LeadsEngine</title>

    <!-- Authentication Guard - Must be first -->
    <script src="assets/js/auth-guard.js"></script>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="assets/css/custom.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-tooth me-2"></i>
                LeadsEngine
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-tachometer-alt me-1"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="leads.html">
                            <i class="fas fa-users me-1"></i>
                            Leads
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-chart-bar me-1"></i>
                            Reports
                        </a>
                    </li>
                    <!-- TODO: Hide Admin section from non-admin users when role check implemented -->
                    <li class="nav-item">
                        <a class="nav-link active" href="admin.html">
                            <i class="fas fa-users-cog me-1"></i>
                            Admin
                        </a>
                    </li>
                </ul>

                <div class="dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" id="user-display">
                        <i class="fas fa-user-circle me-2"></i>
                        <span id="user-name">Loading...</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Profile</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Settings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="logoutButton"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="admin.html">Admin</a></li>
                <li class="breadcrumb-item active" aria-current="page">User Management</li>
            </ol>
        </nav>

        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h1 class="text-gradient mb-2">User Management</h1>
                <p class="text-muted">Manage system users and permissions</p>
            </div>
            <div class="col-md-6 text-end">
                <!-- TODO: Only show this toggle to admin roles 1 and 2 -->
                <div class="form-check form-switch d-inline-block me-3" style="font-size: 1.1rem;">
                    <input class="form-check-input" type="checkbox" id="show-archived-toggle" style="cursor: pointer;">
                    <label class="form-check-label" for="show-archived-toggle" style="cursor: pointer;">
                        Show Archived Users
                    </label>
                </div>
                <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addUserModal">
                    <i class="fas fa-user-plus me-2"></i>
                    New User
                </button>
            </div>
        </div>

        <!-- Filter and Results Summary -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-info-circle text-primary me-2"></i>
                                <span id="resultsCount">Loading users...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="card">
            <div class="card-body">
                <!-- Loading State -->
                <div id="loadingState" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-3">Loading users...</p>
                </div>

                <!-- Error State -->
                <div id="errorState" class="alert alert-danger" style="display: none;" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage">Failed to load users</span>
                </div>

                <!-- Users Table -->
                <div class="table-responsive">
                    <table class="table table-hover" id="usersTable">
                        <thead>
                            <tr>
                                <th style="cursor: pointer;">ID <i class="fas fa-sort ms-1"></i></th>
                                <th style="cursor: pointer;">Full Name <i class="fas fa-sort ms-1"></i></th>
                                <th style="cursor: pointer;">Email <i class="fas fa-sort ms-1"></i></th>
                                <th>Roles</th>
                                <th style="cursor: pointer;">Status <i class="fas fa-sort ms-1"></i></th>
                                <th style="cursor: pointer;">Created Date <i class="fas fa-sort ms-1"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows populated by admin.js -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         MODALS
         ============================================ -->

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>
                        Add New User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Error Summary -->
                    <div class="alert alert-danger" id="add-user-error-summary" style="display: none;"></div>

                    <form id="addUserForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="add-full-name" class="form-label">Full Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="add-full-name" name="full_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="add-email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="add-email" name="email" required>
                                <small class="text-muted">Used as username for login</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="add-password" class="form-label">Password <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="add-password" name="password" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Role <span class="text-danger">*</span></label>
                                <div id="add-roles-radios" class="border rounded p-3">
                                    <!-- Populated dynamically with radio buttons -->
                                </div>
                                <small class="text-muted d-block mt-1">Higher roles inherit permissions from lower roles</small>
                                <small class="text-danger" id="add-roles-error" style="display: none;">Please select a role</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="add-user-confirm-btn">
                        <i class="fas fa-save me-1"></i>
                        Create User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-edit me-2"></i>
                        Edit User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Error Summary -->
                    <div class="alert alert-danger" id="edit-user-error-summary" style="display: none;"></div>

                    <form id="editUserForm">
                        <input type="hidden" id="edit-user-id">

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-full-name" class="form-label">Full Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="edit-full-name" name="full_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="edit-email" name="email" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="edit-password" class="form-label">Password <small class="text-muted">(leave blank to keep current)</small></label>
                                <input type="password" class="form-control" id="edit-password" name="password">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Role <span class="text-danger">*</span></label>
                                <div id="edit-roles-radios" class="border rounded p-3">
                                    <!-- Populated dynamically with radio buttons -->
                                </div>
                                <small class="text-muted d-block mt-1">Higher roles inherit permissions from lower roles</small>
                                <small class="text-danger" id="edit-roles-error" style="display: none;">Please select a role</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="edit-user-confirm-btn">
                        <i class="fas fa-save me-1"></i>
                        Update User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete/Archive User Modal -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-archive me-2"></i>
                        Archive User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Archived users can be restored by an administrator.
                    </div>
                    <p>Are you sure you want to archive <strong id="delete-user-name"></strong>?</p>
                    <div class="alert alert-danger" id="delete-user-error" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="delete-cancel-btn">Cancel</button>
                    <button type="button" class="btn btn-warning" id="delete-confirm-btn">
                        <i class="fas fa-archive me-1"></i>
                        Archive User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Restore User Modal -->
    <div class="modal fade" id="restoreUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-undo me-2"></i>
                        Restore User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Restore <strong id="restore-user-name"></strong>?</p>
                    <div class="alert alert-danger" id="restore-user-error" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="restore-cancel-btn">Cancel</button>
                    <button type="button" class="btn btn-success" id="restore-confirm-btn">
                        <i class="fas fa-undo me-1"></i>
                        Restore User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container (for notifications) -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- jQuery (required for some Bootstrap components) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- App Scripts -->
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/bus.js"></script>
    <script src="assets/js/validation.js"></script>
    <script src="assets/js/admin.js"></script>

    <script>
        $(document).ready(function() {
            // Logout functionality
            document.getElementById('logoutButton').addEventListener('click', function(e) {
                e.preventDefault();
                Auth.logout();
            });

            // Add user button
            $('#add-user-confirm-btn').on('click', function() {
                AdminPage.createUser();
            });

            // Edit user button
            $('#edit-user-confirm-btn').on('click', function() {
                AdminPage.updateUser();
            });

            // Delete/Archive user button
            $('#delete-confirm-btn').on('click', function() {
                AdminPage.deleteUser();
            });

            // Restore user button
            $('#restore-confirm-btn').on('click', function() {
                AdminPage.restoreUser();
            });

            // Toggle archived users view
            $('#show-archived-toggle').on('change', function() {
                AdminPage.toggleArchivedView();
            });
        });
    </script>
</body>
</html>
